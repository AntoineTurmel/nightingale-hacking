<?xml version="1.0"?>
<!DOCTYPE window SYSTEM "chrome://albumartmanager/locale/albumartmanager.dtd" >

<bindings xmlns="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
          xmlns:xbl="http://www.mozilla.org/xbl">

  <!--
    \brief albumplace is a place holder for an albums cover, it contains
           an image of the cover, the name of the album, a popup menu so the
           user can change the cover image, and a spinner that indicates when
           a cover request is being made.
           This is dependent on AlbumArtManager.
  -->
  <binding id="albumplace">
    <resources>
      <stylesheet src="chrome://albumartmanager/skin/albumart.css" />
    </resources>
    <content>
      <xul:menupopup sid="albumMenu"
                     onpopupshowing="this.parentNode.createMenu(this);"
                     onpopuphiding="this.parentNode.cleanMenu(this);">
        <xul:menuseparator />
        <xul:menuitem label="&albumartmanager.menu.clear;"
                      oncommand="this.parentNode.parentNode.clearCover();"/>
      </xul:menupopup>

      <xul:vbox class="albumBox"
                xbl:inherits="tooltiptext=value">
        <xul:stack>
          <!-- Album Cover -->
          <xul:image sid="sb-album-artcover"
                     xbl:inherits="src"
                     class="albumArt" />

          <!-- Searching Spinner -->
          <xul:vbox class="spinnerBox"
                    sid="sb-album-spinner"
                    top="82" left="82"
                    xbl:inherits="searching">
            <xul:image class="spinnerImage"
                       src="chrome://songbird/skin/icons/spinner-spin.png"/>
          </xul:vbox>

        </xul:stack>
        <xul:hbox align="center" flex="1">
          <xul:label sid="sb-album-name"
                     xbl:inherits="value"
                     class="albumName"
                     crop="end" />
        </xul:hbox>
      </xul:vbox>
    </content>

    <implementation>
      <method name="clearCover">
        <body><![CDATA[
          var mGuid = this.getAttribute("mediaItemGuid");
          var mMediaItem = LibraryUtils.mainLibrary.getMediaItem(mGuid);
          if (!mMediaItem) {
            return;
          }
          
          AlbumArtManager.clearAlbumArt(mMediaItem);
        ]]></body>
      </method>

      <method name="getCover">
        <parameter name="aService" />
        <body><![CDATA[
          var mGuid = this.getAttribute("mediaItemGuid");
          var mMediaItem = LibraryUtils.mainLibrary.getMediaItem(mGuid);
          if (!mMediaItem) {
            return;
          }
          
          AlbumArtManager.getAlbumArt(mMediaItem, aService);
        ]]></body>
      </method>
      
      <method name="createMenu">
        <parameter name="aMenu" />
        <body><![CDATA[
          this._menuOpen = true;
          AlbumArtManager.createMenuPopup(aMenu);
        ]]></body>
      </method>

      <method name="cleanMenu">
        <parameter name="aMenu" />
        <body><![CDATA[
          // Remove the fetcher menu entries
          this._menuOpen = false;
          var fChild = aMenu.firstChild;
          while (fChild) {
            var nChild = fChild.nextSibling;
            var sbid = fChild.getAttribute("sbid");
            if (sbid != null && sbid != "") {
              aMenu.removeChild(fChild);
            }
            fChild = nChild;
          }
          
        ]]></body>
      </method>

    </implementation>

    <handlers>
      <!-- button="1" == middle button -->
      <handler event="click"
               button="0"
               clickcount="2">
        <![CDATA[
          // XXX Hack fix this!
          // When you open the menu and click an entry it will pass that back
          // and also open the preview :P
          if (this._menuOpen) {
            return;
          }

          // We either show the album cover or play the album
          if (this.getAttribute("doPlay")) {
            alert("We should play something :)");
          } else {
            // Show full size album cover
            var albumImage =  document.getAnonymousElementByAttribute(
                                                          this,
                                                          'sid',
                                                          'sb-album-artcover');
            var coverUrl = albumImage.getAttribute("src");
            window.openDialog("chrome://albumartmanager/content/xul/coverPreview.xul",
                         "coverPreview",
                         "all",
                         coverUrl);
          }
        ]]>
      </handler>
      
      <handler event="click"
               button="2"
               clickcount="1">
        <![CDATA[
          // XXX Hack fix this!
          // When you open the menu and click an entry it will pass that back
          // and also open the preview :P
          if (this._menuOpen) {
            return;
          }
        
          // Show popup menu
          var albumMenu = document.getAnonymousElementByAttribute(this, "sid", "albumMenu");
          albumMenu.openPopup(null, "", event.clientX, event.clientY, false, false);
        ]]>
      </handler>
    </handlers>
  </binding>

</bindings>
