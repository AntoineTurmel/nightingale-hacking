<!--
	Copyright (c) 2007, POTI Inc. All Rights Reserved.

	Redistribution and use in source and binary forms, with or without 
	modification, are permitted provided that the following conditions are met:
	
	* Redistributions of source code must retain the above copyright notice, 
	this list of conditions and the following disclaimer.
	
	* Redistributions in binary form must reproduce the above copyright notice, 
	this list of conditions and the following disclaimer in the documentation 
	and/or other materials provided with the distribution.
	
	* Neither the name of POTI Inc. or Songbird nor the names of its contributors 
	may be used to endorse or promote products derived from this software without 
	specific prior written permission.

	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
	"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
	LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
	A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
	CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
	EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
	PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
	PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
	LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
	NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
	SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html>
	<head>
		<title>Sample Music Store</title>		
		<script language="Javascript" src="musicstore.js"></script>
		<script language="Javascript" src="albums.js"></script>

		<link href="default.css" rel="stylesheet" type="text/css" >
		<link rel="search" type="application/opensearchdescription+xml" title="Sample Music Store" href="search.xml">		
		
		<script language="Javascript">		
		
		function showPlayList() {
			/*
			 * Show play list. This needs to be called first so that the column manipulation have the right effect
			 */
			gPlaylist.show();

						
			/*
			 * Create columns on the playlist view. This has to be done before any items with a custom property is added to the playlist otherwise, the
			 * type and column name can't be overriden.
			 */

			/* 
			 * Create a custom property for duration because the actual duration of the sample track is 30s and the media core will
			 * update it upon playback to the real duration. The duration of the full track needs to be displayed instead.
			 */			
			gPlaylist.addTextColumn("http://yourdomain.com/path/to/data#duration", "Duration", 100);

			/*
			 * Custom property for price. This will be the displayed price formatted with currency symbol.
			 */
			gPlaylist.addTextColumn("http://yourdomain.com/path/to/data#price", "Price", 100);

			/* 
			 * This is a hidden property for the price represented as a number.
			 */
			gPlaylist.addColumn("number", "http://yourdomain.com/path/to/data#priceInDollar", "", "", "", true, false, false, 0, 0);
			
			/* 
			 * This column will contain the button to add the track to the cart
			 */
			gPlaylist.addButton("http://yourdomain.com/path/to/data#button1", "", "", 150);
			
			/* 
			 * This is a hidden property to reference the track back to an id, a foreign key in a database for instance
			 */
			gPlaylist.addColumn("text", "http://yourdomain.com/path/to/data#id", "", "", "", true, false, false, 0, 0);


			/*
			 * These are songbird pre-defined properties. Hide corresponding columns.
			 * Complete list of properties can be found at
			 * http://publicsvn.songbirdnest.com/browser/trunk/components/property/src/sbStandardProperties.h
			 */
			gPlaylist.hideColumn("http://songbirdnest.com/data/1.0#downloadButton");
			gPlaylist.hideColumn("http://songbirdnest.com/data/1.0#duration");
			gPlaylist.showColumn("http://songbirdnest.com/data/1.0#trackNumber");
			
			/* 
			 * Set custom properties common for all tracks
			 */
			var props = {}; 
			
			props["http://yourdomain.com/path/to/data#button1"] =  "Add Song";
			
			for (i = 0; i < albums.length; i++) {
				var track = albums[i];

				props["http://yourdomain.com/path/to/data#id"] = track.id;
				
				props["http://yourdomain.com/path/to/data#price"] = "$" + track.price;
				props["http://yourdomain.com/path/to/data#priceInDollar"] = track.price;

				props["http://yourdomain.com/path/to/data#duration"] =  MusicStore.formatDuration(track.duration);
				
				/*
				 * These are songbird pre-defined properties. Hide corresponding columns.
				 * Complete list of properties can be found at 
				 * http://publicsvn.songbirdnest.com/browser/trunk/components/property/src/sbStandardProperties.h
				 */
				props["http://songbirdnest.com/data/1.0#artistName"] = track.artist;
				props["http://songbirdnest.com/data/1.0#albumName"] = track.album;
				props["http://songbirdnest.com/data/1.0#trackName"] = track.name;
				props["http://songbirdnest.com/data/1.0#duration"] = track.duration;
				props["http://songbirdnest.com/data/1.0#trackNumber"] = track.number;
				props["http://songbirdnest.com/data/1.0#genre"] = track.genre;

				gPlaylist.add(track.previewUrl, props);				
			}


		}


		function addToCart(item) {
			var myDiv = document.getElementById("cart");
			
			/*
			 * Check to see if this track is already in the user's library and warn the user.
			 * This check would probably be best done on the server against account history information of the user.
			 */
			var found = false;
			var listener = {
				onEnumerationBegin: function() {
					return true;
				},
				onEnumeratedItem: function(list, thisItem) {
					found = true;
					return false;
				},
				onEnumerationEnd: function() {
					return true;
				}
			};
			
			// If the user does not grant permission for the site to look in the local library, this will raise an exception
			try {
				songbird.mainLibrary.enumerateItemsByProperty("http://yourdomain.com/path/to/data#id",  item.getProperty("http://yourdomain.com/path/to/data#id"), listener, 0);
			
				if (found) {
					if (!confirm("\"" + item.getProperty("http://songbirdnest.com/data/1.0#trackName") + " by " + item.getProperty("http://songbirdnest.com/data/1.0#artistName") + "\" is already in your library.\n\nDo you want to proceed and add it your cart anyway?")) {
						return;
					}
				}
			} catch (e) {
				// Message the user that they can provide a better experience by allowing this site to read their local library
				document.getElementById("notification").style.visibility = "visible";
			}
			
			// If already in cart, don't add it
			if (!gCart.contains("http://yourdomain.com/path/to/data#id", item.getProperty("http://yourdomain.com/path/to/data#id"))) {
				var props = {}; 
				props["http://yourdomain.com/path/to/data#id"] = item.getProperty("http://yourdomain.com/path/to/data#id");				
				props["http://yourdomain.com/path/to/data#priceInDollar"] = item.getProperty("http://yourdomain.com/path/to/data#priceInDollar");
				props["http://yourdomain.com/path/to/data#price"] = item.getProperty("http://yourdomain.com/path/to/data#price");
				props["http://yourdomain.com/path/to/data#duration"] = item.getProperty("http://yourdomain.com/path/to/data#duration");
				
				props["http://songbirdnest.com/data/1.0#trackName"] = item.getProperty("http://songbirdnest.com/data/1.0#trackName");
				props["http://songbirdnest.com/data/1.0#artistName"] = item.getProperty("http://songbirdnest.com/data/1.0#artistName");
				props["http://songbirdnest.com/data/1.0#albumName"] = item.getProperty("http://songbirdnest.com/data/1.0#albumName");
				props["http://songbirdnest.com/data/1.0#genre"] = item.getProperty("http://songbirdnest.com/data/1.0#genre");
				props["http://songbirdnest.com/data/1.0#duration"] = item.getProperty("http://songbirdnest.com/data/1.0#duration");
				props["http://songbirdnest.com/data/1.0#trackNumber"] = item.getProperty("http://songbirdnest.com/data/1.0#trackNumber");	

				props["http://yourdomain.com/path/to/data#button1"] =  "Remove";
			
			
				gCart.add(item.getProperty("http://songbirdnest.com/data/1.0#contentURL"), props);

				/*
				 * Provide user with feedback
				 */
		        myDiv.textContent="Added \"" + item.getProperty("http://songbirdnest.com/data/1.0#trackName") + " by " + item.getProperty("http://songbirdnest.com/data/1.0#artistName") + "\" to your cart.";

			} else {
				myDiv.textContent="\"" + item.getProperty("http://songbirdnest.com/data/1.0#trackName") + " by " + item.getProperty("http://songbirdnest.com/data/1.0#artistName") + "\" is already in your cart.";		        
			}
		}
		
		var onAddSelected =  function (event) {
			if (event.property == "http://yourdomain.com/path/to/data#button1") {
			     if ("item" in event) {
					addToCart(event.item);
				}
			}
		}

		var onViewCartSelected = function (event) {
			window.location = "cart.html";
		}

	
		var gPlaylist = null;
	 	var gCart = null;
	
		function load() {
			/*
			 * This is the playlist that will hold the track to be displayed
			 */
			gPlaylist = MusicStore.getSitePlayList(null);
			
			/*
			 * This is another playlist that will hold selected items that are placed in the cart. This demonstrate
			 * how the list gets persisted and the content can be accessed during subsequent session.
			 */		
			gCart = MusicStore.getSitePlayList("cart");
						
			// Display the playlist in the player
			showPlayList();		

			/*
			 * Add a custom button on the chrome of the player
			 * See http://developer.songbirdnest.com/documentation/trunk/webpageapi/files/sbIRemoteCommands-idl.html#Commands.addCommand
			 */
	   		document.addEventListener("button-view-cart", onViewCartSelected, false);
			songbird.commands.addCommand("action", "button-view-cart", "View Shopping Cart", "View shopping cart");      				
			
			/*
			 * Listen to event to detect button press in the playlist
			 */
			document.addEventListener("PlaylistCellClick", onAddSelected, false);
		}

	    function unload() {
			document.removeEventListener("PlaylistCellClick", onAddSelected, false);
			document.removeEventListener("button-view-cart", onViewCartSelected, false);
			
			// Stop playback if any
		    try {
				songbird.pause();
	      	} catch (e) {
	      	}
	
			// Clean up temp list
			gPlaylist.destroy();
		}
 		
		</script>		
	</head>
	<body onload="load();" onunload="unload();" >
		<div class="bug" id="notification">
			<img class="icon" src="images/arrow1_nw.gif"/>To provide a better experience,<br/> allow this site to access your library.
		</div>
		
		<h1>Sample Music Store</h1>
		<hr/>
		
		<h1 class="artist">Various Artists</h1>

		<div id="album-details">
			<img class="cover" src="http://upload.wikimedia.org/wikipedia/en/thumb/c/ce/Wired.jpg/200px-Wired.jpg" />
			<h2 class="album"><a href="http://en.wikipedia.org/wiki/The_Wired_CD" target="_new">The Wired CD</a></h2>
			<ul>
				<li>Released 2004</li>
				<li>Total: 16 songs</li>
			</ul>
			<p>
				The Wired CD is an album that was released in 2004 as a collaborative effort between Wired magazine, Creative Commons, and sixteen musicians and groups.
			</p>
		</div>
	
		<!-- Area to provide user feedback on what's been added to the cart -->
		<div id="cart">
		</div>
	</body>
</html>