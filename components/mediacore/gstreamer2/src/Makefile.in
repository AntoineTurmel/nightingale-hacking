DEPTH     = ../../../..
topsrcdir = @top_srcdir@
srcdir    = @srcdir@
VPATH     = @srcdir@

include $(DEPTH)/build/autodefs.mk

GST_VERSION=0.10
GLIB_VERSION=2.0

ifdef DEBUG
MODULE = sbGStreamerMediacore_d
moz_utils = sbMozStringUtils_d
else
MODULE = sbGStreamerMediacore
moz_utils = sbMozStringUtils
endif

CPP_SRCS = $(topsrcdir)/components/mediacore/base/src/sbBaseMediacore.cpp \
           $(topsrcdir)/components/mediacore/base/src/sbBaseMediacoreEventTarget.cpp \
           $(topsrcdir)/components/mediacore/base/src/sbBaseMediacoreFactory.cpp \
           $(topsrcdir)/components/mediacore/base/src/sbBaseMediacorePlaybackControl.cpp \
           $(topsrcdir)/components/mediacore/base/src/sbBaseMediacoreVolumeControl.cpp \
           $(topsrcdir)/components/mediacore/base/src/sbMediacoreCapabilities.cpp \
           $(topsrcdir)/components/mediacore/base/src/sbMediacoreEvent.cpp \
           sbGStreamerService.cpp \
           sbGStreamerMediacore.cpp \
           sbGStreamerMediacoreFactory.cpp \
           sbGStreamerMediacoreModule.cpp \
           sbGStreamerMediacoreUtils.cpp \
           sbGStreamerPlatformBase.cpp \
           $(NULL)

ifeq (windows,$(SB_PLATFORM))
	  CPP_SRCS += sbGStreamerPlatformWin32.cpp
else
ifeq (macosx, $(SB_PLATFORM))
	   # Nothing yet; we don't have a macos implementation
else
	  # Others - linux, solaris, etc.
	  CPP_SRCS += sbGStreamerPlatformGDK.cpp
endif
endif

CPP_INCLUDES = \
      $(topsrcdir)/components/include \
      $(DEPTH)/components/mediacore/base/public \
      $(topsrcdir)/components/mediacore/base/src \
      $(DEPTH)/components/mediacore/gstreamer2/public \
      $(topsrcdir)/components/moz/strings/src \
	  $(DEPTH)/components/property/public \
	  $(topsrcdir)/components/property/src \
      $(MOZSDK_INCLUDE_DIR) \
      $(MOZSDK_INCLUDE_DIR)/nspr \
      $(MOZSDK_INCLUDE_DIR)/xpcom \
      $(MOZSDK_INCLUDE_DIR)/string \
      $(MOZSDK_INCLUDE_DIR)/layout \
      $(MOZSDK_INCLUDE_DIR)/gfx \
      $(MOZSDK_INCLUDE_DIR)/widget \
      $(MOZSDK_INCLUDE_DIR)/content \
      $(MOZSDK_INCLUDE_DIR)/necko \
      $(MOZSDK_INCLUDE_DIR)/locale \
      $(MOZSDK_INCLUDE_DIR)/dom \
      $(MOZSDK_INCLUDE_DIR)/docshell \
      $(MOZSDK_INCLUDE_DIR)/windowwatcher \
      $(MOZSDK_INCLUDE_DIR)/appshell \
      $(MOZSDK_INCLUDE_DIR)/intl \
      $(MOZSDK_INCLUDE_DIR)/pref \
      $(MOZSDK_INCLUDE_DIR)/xulapp \
      $(MOZSDK_IDL_DIR) \
      $(NULL)

ifdef MEDIA_CORE_GST_SYSTEM
  CPP_EXTRA_FLAGS = -DGST_SYSTEM=1

  CPP_EXTRA_INCLUDES = $(GSTREAMER_CFLAGS) \
                       $(GTK_CFLAGS) \
                       $(NULL)
else
  CPP_EXTRA_INCLUDES = -I$(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/include/gstreamer-$(GST_VERSION) \
                       -I$(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/include/gstreamer-$(GST_VERSION) \
                       $(NULL)

  ifeq (,$(filter-out macosx windows,$(SB_PLATFORM)))
    # macosx or windows
    CPP_EXTRA_INCLUDES += -I$(DEPS_DIR)/glib/$(SB_CONFIGURATION)/include/glib-$(GLIB_VERSION) \
                          -I$(DEPS_DIR)/glib/$(SB_CONFIGURATION)/lib/glib-$(GLIB_VERSION)/include \
                          $(NULL)
  else
    # everything else
    CPP_EXTRA_INCLUDES += $(GTK_CFLAGS) \
                          $(NULL)
  endif
endif

# The dynamic gstreamer libs on windows have "-0" appended to their names
ifeq (windows,$(SB_PLATFORM))
  GST_LIB_SUFFIX=-0
endif

DYNAMIC_LIB = $(MODULE)$(DLL_SUFFIX)

DYNAMIC_LIB_OBJS = $(notdir $(CPP_SRCS:.cpp=$(OBJ_SUFFIX))) \
                   $(NULL)


DYNAMIC_LIB_EXTRA_IMPORTS = \
      nspr4 \
	  plds4 \
      xpcomglue_s \
      xpcom \
      $(moz_utils) \
      gstpbutils-$(GST_VERSION)$(GST_LIB_SUFFIX) \
      gstinterfaces-$(GST_VERSION)$(GST_LIB_SUFFIX) \
      $(NULL)

DYNAMIC_LIB_IMPORT_PATHS = \
      $(MOZSDK_LIB_DIR) \
      $(DEPTH)/components/moz/strings/src \
      $(NULL)

# Use system headers for MEDIA_CORE_GST_SYSTEM only
ifdef MEDIA_CORE_GST_SYSTEM
  CPP_EXTRA_FLAGS += $(GSTREAMER_CFLAGS) \
                     $(NULL)

  DYNAMIC_LIB_EXTRA_FLAGS = $(GSTREAMER_LIBS) \
                            $(GTK_LIBS) \
                            -lX11 \
                            $(NULL)
else

  DYNAMIC_LIB_EXTRA_IMPORTS += gstreamer-$(GST_VERSION)$(GST_LIB_SUFFIX) \
                              $(NULL)
  DYNAMIC_LIB_IMPORT_PATHS += $(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/lib \
                              $(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/lib \
                              $(NULL)

  ifeq (,$(filter-out macosx windows,$(SB_PLATFORM)))
    # macosx or windows
    DYNAMIC_LIB_EXTRA_IMPORTS += intl \
                                 iconv \
                                 glib-$(GLIB_VERSION) \
                                 gmodule-$(GLIB_VERSION) \
                                 gobject-$(GLIB_VERSION) \
                                 gthread-$(GLIB_VERSION) \
                                 $(NULL)
    DYNAMIC_LIB_IMPORT_PATHS += $(DEPS_DIR)/glib/$(SB_CONFIGURATION)/lib \
                                $(DEPS_DIR)/libiconv/$(SB_CONFIGURATION)/lib \
                                $(DEPS_DIR)/gettext/$(SB_CONFIGURATION)/lib \
                                $(NULL)
  else
    # everything else
    DYNAMIC_LIB_EXTRA_FLAGS += $(GTK_LIBS) \
                               -lX11 \
                               $(NULL)
  endif
endif

SONGBIRD_COMPONENTS = $(srcdir)/sbAboutGStreamer2.js \
                      $(NULL)

# We use the stub loader to load this dll, so stick it in the lib directory
SONGBIRD_LIB = $(DYNAMIC_LIB) \
               $(NULL)

include $(topsrcdir)/build/rules.mk
