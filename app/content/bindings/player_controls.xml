<?xml version="1.0"?>
<!--
/*
//
// BEGIN SONGBIRD GPL
// 
// This file is part of the Songbird web player.
//
// Copyright© 2006 Pioneers of the Inevitable LLC
// http://songbirdnest.com
// 
// This file may be licensed under the terms of of the
// GNU General Public License Version 2 (the “GPL”).
// 
// Software distributed under the License is distributed 
// on an “AS IS” basis, WITHOUT WARRANTY OF ANY KIND, either 
// express or implied. See the GPL for the specific language 
// governing rights and limitations.
//
// You should have received a copy of the GPL along with this 
// program. If not, go to http://www.gnu.org/licenses/gpl.html
// or write to the Free Software Foundation, Inc., 
// 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
// 
// END SONGBIRD GPL
//
 */
-->

<!DOCTYPE window SYSTEM "chrome://songbird/locale/songbird.dtd" >

<bindings xmlns="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
          xmlns:xbl="http://www.mozilla.org/xbl">


  
  
  <!-- VOLUME CONTROL -->

  
  
  
  <binding id="volume" extends="chrome://songbird/content/bindings/progress_slider.xml#progress_slider">

   <handlers>
     <handler event="progress_slider-change" action="this.onTrackVolume();"/>
     <handler event="progress_slider-release" action="this.onReleaseVolume();"/>
   </handlers>

  <implementation>

    <constructor>
      <![CDATA[
        var jsLoader = Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);
        jsLoader.loadSubScript( "chrome://songbird/content/scripts/sbIDataRemote.js", this );

        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);
        this.remote_volume = new sbIDataRemote( "faceplate.volume" );
        this.remote_lastVolume = new sbIDataRemote("faceplate.volume.last");
        //this.remote_trackerVolume = new sbIDataRemote( "faceplate.volume.tracker" );
          
        var onremotevolumechange = { 
          _that: null, 
          handleEvent: function( event ) { this._that.onRemoteVolumeChange(); } 
        } onremotevolumechange._that = this;
        this.remote_volume.bindCallbackFunction(onremotevolumechange, true);

        this.maxpos = 255;
        this.value = this.remote_volume.getIntValue();
        this.trackingVolume = 0;
      ]]>
    </constructor>
    <destructor>
    </destructor>
    
    <method name="onTrackVolume">
      <body>
        <![CDATA[
          //this.remote_trackerVolume.setValue(true); // prevents the core from updating the volume controls while we move them
          this.trackingVolume = 1; // prevents this volume control from being updated while it is being moved (but other volume controls are updated with our motion)
          this.gPPS.setVolume(this.value);
          this.remote_volume.setValue(this.value);
          if (this.value == 0) 
          {
            // set mute when we bring the volume to 0
            this.gPPS.setMute(true);
          }
          else
          {
            // otherwise reset it, and record the last volume
            this.gPPS.setMute(false);
          }
        ]]>
      </body>
    </method>

    <method name="onReleaseVolume">
      <body>
        this.trackingVolume = 0;
        //this.remote_trackerVolume.setValue(false); 
        this.gPPS.setVolume(this.value);
        if (this.value != 0) 
        {
          this.remote_lastVolume.setValue(this.value);
        }
      </body>
    </method>

    <method name="onRemoteVolumeChange">
      <body>
        <![CDATA[
          try {
            if (this.trackingVolume) return; // we are the control changing the volume, ignore this callback
            this.value = this.remote_volume.getIntValue();
          } catch (e) {
            alert("player_controls.xml - onRemoteVolumeChange - " + e);
          }
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>

  
  
  
  <!-- MUTE CONTROL -->




  <binding id="mute">
  
   <content>
     <xul:stack xbl:inherits="class=class" >
       <xul:button sbid="mute_off" xbl:inherits="class=class,id=muteoffid" oncommand="onMute( );" tooltiptext="&tooltip.control.mute;"/>
       <xul:button sbid="mute_on"  xbl:inherits="class=class,id=muteonid" oncommand="onMute( );" tooltiptext="&tooltip.control.mute;"/>
     </xul:stack>
   </content>

  <implementation>

    <constructor>
      <![CDATA[
        var jsLoader = Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);
        jsLoader.loadSubScript( "chrome://songbird/content/scripts/sbIDataRemote.js", this );

        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);
        this.remote_volume = new sbIDataRemote( "faceplate.volume" );
        this.remote_lastVolume = new sbIDataRemote( "faceplate.volume.last" );
        this.remote_mute = new sbIDataRemote( "faceplate.mute" );
        
        this.bindmuteon = SBDataBindElementAttribute( "faceplate.mute", this.mute_on, "hidden", true, true );
        this.bindmuteoff = SBDataBindElementAttribute( "faceplate.mute", this.mute_off, "hidden", true );
      ]]>
    </constructor>
    <destructor>
    </destructor>

    <field name="mute_on">document.getAnonymousElementByAttribute(this, 'sbid', 'mute_on');</field>
    <field name="mute_off">document.getAnonymousElementByAttribute(this, 'sbid', 'mute_off');</field>

    <method name="onMute">
      <body>
        <![CDATA[
          var newmute = !this.gPPS.getMute(); 
          this.gPPS.setMute(newmute);
          if (!newmute) // restore last volume when coming back from mute state
          {
            this.gPPS.setVolume(this.remote_lastVolume.getIntValue());
          } 
          else
          {
            this.gPPS.setVolume(0);
          }
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>


  

  <!-- FORWARD BUTTON-->

  
  
  
  <binding id="forward" extends="chrome://global/content/bindings/button.xml#button-base">

   <handlers>
     <handler event="mousedown" action="this.onFwdMouseDown();"/>
     <handler event="mouseup" action="this.onFwdMouseUp();"/>
   </handlers>

  <implementation>

    <constructor>
      <![CDATA[
        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);

        this.seen_skip = false;
        this.skip = false;
        this.skip_interval = null;
      ]]>
    </constructor>

    <destructor>
    </destructor>
    
    <method name="onFwdMouseDown">
      <body>
        <![CDATA[
          this.seen_skip = false;
          if ( this.gPPS.getPlaying() )
          {
            this.skip = true;
            if ( ! this.skip_interval )
            {
              document.__SKIPLOOPOBJECT__ = this;
              this.skip_interval = setInterval( this.skipLoop, 1000 );
            }
          }
        ]]>
      </body>
    </method>

    <method name="onFwdMouseUp">
      <body>
        <![CDATA[
          this.skip = false;
          this.onFwdCommand();
        ]]>
      </body>
    </method>

    <method name="onFwdCommand">
      <body>
        <![CDATA[
          if ( !this.seen_skip )
          {
            this.gPPS.next();
          }
        ]]>
      </body>
    </method>

    <method name="skipLoop">
      <body>
        <![CDATA[
          var _this = document.__SKIPLOOPOBJECT__;
          if ( _this.skip )
          {
            _this.seen_skip = true;
            _this.gPPS.setPosition( _this.gPPS.getPosition() + 15000 );
          }
          else
          {
            clearInterval( _this.skip_interval );
            _this.skip_interval = null;
          }
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>


  
  
  <!-- BACK BUTTON-->

  
  
  
  <binding id="back" extends="chrome://global/content/bindings/button.xml#button-base">

   <handlers>
     <handler event="mousedown" action="this.onBackMouseDown();"/>
     <handler event="mouseup" action="this.onBackMouseUp();"/>
   </handlers>

  <implementation>

    <constructor>
      <![CDATA[
        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);

        this.seen_skip = false;
        this.skip = false;
        this.skip_interval = null;
      ]]>
    </constructor>

    <destructor>
    </destructor>
    
    <method name="onBackMouseDown">
      <body>
        <![CDATA[
          this.seen_skip = false;
          if ( this.gPPS.getPlaying() )
          {
            this.skip = true;
            if ( ! this.skip_interval )
            {
              document.__SKIPLOOPOBJECT__ = this;
              this.skip_interval = setInterval( this.skipLoop, 1000 );
            }
          }
        ]]>
      </body>
    </method>

    <method name="onBackMouseUp">
      <body>
        <![CDATA[
          this.skip = false;
          this.onBackCommand();
        ]]>
      </body>
    </method>

    <method name="onBackCommand">
      <body>
        <![CDATA[
          if ( !this.seen_skip )
          {
            this.gPPS.previous();
          }
        ]]>
      </body>
    </method>

    <method name="skipLoop">
      <body>
        <![CDATA[
          var _this = document.__SKIPLOOPOBJECT__;
          if ( _this.skip )
          {
            _this.seen_skip = true;
            _this.gPPS.setPosition( _this.gPPS.getPosition() - 15000 );
          }
          else
          {
            clearInterval( _this.skip_interval );
            _this.skip_interval = null;
          }
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>

  
  
  
  <!-- REPEAT CONTROL -->




  <binding id="repeat">
  
   <content>
     <xul:stack xbl:inherits="class=class" >
       <xul:button sbid="repeat_none" xbl:inherits="class=class,id=repid" oncommand="onRepeat( );" tooltiptext="&tooltip.control.repeat;"/>
       <xul:button sbid="repeat_1" xbl:inherits="class=class,id=rep1id" oncommand="onRepeat( );" tooltiptext="&tooltip.control.repeat;"/>
       <xul:button sbid="repeat_all" xbl:inherits="class=class,id=repallid" oncommand="onRepeat( );" tooltiptext="&tooltip.control.repeat;"/>
     </xul:stack>
   </content>

  <implementation>

    <constructor>
      <![CDATA[
        var jsLoader = Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);
        jsLoader.loadSubScript( "chrome://songbird/content/scripts/sbIDataRemote.js", this );

        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);
        
        this.remote_repeat = new sbIDataRemote( "playlist.repeat" ); 
        this.repnonebinding = SBDataBindElementAttribute( "playlist.repeat", this.repeat_none, "hidden", true, false, "parseInt( value ) != 0" );
        this.rep1binding = SBDataBindElementAttribute( "playlist.repeat", this.repeat_1, "hidden", true, false, "parseInt( value ) != 1" );
        this.repallbinding = SBDataBindElementAttribute( "playlist.repeat", this.repeat_all, "hidden", true, false, "parseInt( value ) != 2" );
      ]]>
    </constructor>
    <destructor>
    </destructor>

    <field name="repeat_none">document.getAnonymousElementByAttribute(this, 'sbid', 'repeat_none');</field>
    <field name="repeat_1">document.getAnonymousElementByAttribute(this, 'sbid', 'repeat_1');</field>
    <field name="repeat_all">document.getAnonymousElementByAttribute(this, 'sbid', 'repeat_all');</field>
    
    <method name="onRepeat">
      <body>
        <![CDATA[
          // Rob decided to change the order.  Woo.
          var value = 0;
          switch ( this.remote_repeat.getIntValue() )
          {
            case 0:
              value = 2;
              break;
            case 1:
              value = 0;
              break;
            case 2:
              value = 1;
              break;
          }
          this.remote_repeat.setValue( value );
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>

  
  
  
  <!-- SHUFFLE CONTROL -->




  <binding id="shuffle">
  
   <content>
     <xul:stack xbl:inherits="class=class" >
       <xul:button sbid="shuffle_off" xbl:inherits="class=class,id=shuffleoffid" oncommand="onShuffle( );" tooltiptext="&tooltip.control.shuffle;"/>
       <xul:button sbid="shuffle_on" xbl:inherits="class=class,id=shuffleonid" oncommand="onShuffle( );" tooltiptext="&tooltip.control.shuffle;"/>
     </xul:stack>
   </content>

  <implementation>

    <constructor>
      <![CDATA[
        var jsLoader = Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);
        jsLoader.loadSubScript( "chrome://songbird/content/scripts/sbIDataRemote.js", this );

        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);
        
        this.remote_shuffle = new sbIDataRemote( "playlist.shuffle" ); 
        this.bindshuffleoff = SBDataBindElementAttribute( "playlist.shuffle", this.shuffle_off, "hidden", true );
        this.bindshuffleon = SBDataBindElementAttribute( "playlist.shuffle", this.shuffle_on, "hidden", true, true );
      ]]>
    </constructor>
    <destructor>
    </destructor>

    <field name="shuffle_off">document.getAnonymousElementByAttribute(this, 'sbid', 'shuffle_off');</field>
    <field name="shuffle_on">document.getAnonymousElementByAttribute(this, 'sbid', 'shuffle_on');</field>
    
    <method name="onShuffle">
      <body>
        <![CDATA[
          this.remote_shuffle.setValue( ( this.remote_shuffle.getIntValue() + 1 ) % 2 );
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>


  
  
  <!-- SEEK CONTROL -->

  
  
  
  <binding id="seekbar" extends="chrome://songbird/content/bindings/progress_slider.xml#progress_slider">

   <handlers>
     <handler event="progress_slider-change" action="this.onTrackSeekbar();"/>
     <handler event="progress_slider-release" action="this.onReleaseSeekbar();"/>
   </handlers>

  <implementation>

    <constructor>
      <![CDATA[
        var jsLoader = Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);
        jsLoader.loadSubScript( "chrome://songbird/content/scripts/sbIDataRemote.js", this );

        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);
        this.remote_position = new sbIDataRemote( "metadata.position" );
        
        var onremotepositionchange = { 
          _that: null, 
          handleEvent: function( event ) { this._that.onRemotePositionChange(); } 
        } onremotepositionchange._that = this;
        this.remote_position.bindCallbackFunction(onremotepositionchange, true);

        this.remote_length = SBDataBindElementAttribute( "metadata.length", this, "maxpos" );
       
        this.trackingPosition = 0;
      ]]>
    </constructor>
    <destructor>
    </destructor>
    
    <method name="onTrackSeekbar">
      <body>
        <![CDATA[
          this.trackingPosition = 1;
        ]]>
      </body>
    </method>

    <method name="onReleaseSeekbar">
      <body>
        this.gPPS.setPosition(this.value);
        this.trackingPosition = 0;
      </body>
    </method>

    <method name="onRemotePositionChange">
      <body>
        <![CDATA[
          try {
            if (this.trackingPosition) return; // we are the control changing the position, ignore this callback
            this.value = gPPS.getPosition();
          } catch (e) {
            alert("player_controls.xml - onRemotePositionChange - " + e);
          }
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>

  
  
  
  <!-- TOTALTIME CONTROL -->




  <binding id="totaltime">
  
   <content>
     <xul:label sbid="timelabel" xbl:inherits="id=id,class=class,align=align,crop=crop,disabled=disabled,flex=flex" onmousedown="onTotalDown();"/> 
   </content>

  <implementation>

    <constructor>
      <![CDATA[
        var jsLoader = Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);
        jsLoader.loadSubScript( "chrome://songbird/content/scripts/sbIDataRemote.js", this );

        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);
        
        this.remote_showRemaining = new sbIDataRemote( "faceplate.showremainingtime" ); 
        this.bindtotaltime = SBDataBindElementAttribute( "metadata.length.str", this.label, "value" );
      ]]>
    </constructor>
    <destructor>
    </destructor>

    <field name="label">document.getAnonymousElementByAttribute(this, 'sbid', 'timelabel');</field>
    
    <method name="onTotalDown">
      <body>
        <![CDATA[
          var len = gPPS.getLength();
          if ( len > 0 )
          {
            this.remote_showRemaining.setValue(!this.remote_showRemaining.getBoolValue());
          }
          // If you try to toggle it while it is zero, you lose the state.
          else
          {
            this.remote_showRemaining.setValue(false);
          }
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>




  <!-- PLAY/PAUSE CONTROL -->




  <binding id="playpause">
  
   <content>
     <xul:stack xbl:inherits="id=id,class=class" flex="1">
       <xul:button sbid="play" xbl:inherits="id=playid,class=class" oncommand="onPlay( );" tooltiptext="&tooltip.control.play;" />
       <xul:button sbid="pause" xbl:inherits="id=pauseid,class=class" oncommand="onPause( );" tooltiptext="&tooltip.control.play;" />
     </xul:stack>
   </content>

  <implementation>

    <constructor>
      <![CDATA[
        var jsLoader = Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);
        jsLoader.loadSubScript( "chrome://songbird/content/scripts/sbIDataRemote.js", this );

        this.gPPS = Components.classes["@songbird.org/Songbird/PlaylistPlayback;1"].getService(Components.interfaces.sbIPlaylistPlayback);
        this.remote_seenPlaying = new sbIDataRemote( "faceplate.seenplaying" ); 
        this.remote_playingRef =  new sbIDataRemote( "playing.ref" ); 
        this.remote_playlistIndex =  new sbIDataRemote( "playlist.index" ); 
        this.pausebinding = SBDataBindElementAttribute( "faceplate.play", this.pause, "hidden", true );
        this.playbinding = SBDataBindElementAttribute( "faceplate.play", this.play, "hidden", true, true );
      ]]>
    </constructor>
    <destructor>
    </destructor>

    <field name="play">document.getAnonymousElementByAttribute(this, 'sbid', 'play');</field>
    <field name="pause">document.getAnonymousElementByAttribute(this, 'sbid', 'pause');</field>
    
    <method name="onPlay">
      <body>
        <![CDATA[
          var ref = "";
          if (this.gPPS.getStarted()) {
            if (this.gPPS.getPaused()) {
              gPPS.play();
            } else {
              // player is buffering, because the play button is visible (not started) yet pause is not set and the player is started
              // start the playlist again at the current spot
              this.gPPS.playRef(this.remote_playingRef.getValue(), this.remote_playlistIndex.getIntValue());
            }
          } else {
            var ref = "";
            var index = 0;
            var playlist = this.getCurrentPlaylist();
            if (playlist) {
              ref = playlist.ref;
              index = playlist.index;
            } 
            if (ref == "") {
              ref = "NC:songbird_library";
              index = 0;
              this.loadLibrary();
              this.gPPS.playTable("songbird", "library", index);
            } else {
              this.gPPS.playRef(ref, index);
            }
          }
        ]]>
      </body>
    </method>

    <method name="onPause">
      <body>
        <![CDATA[
          if ( this.remote_seenPlaying.getBoolValue() )
          {
            this.gPPS.pause();
          }
        ]]>
      </body>
    </method>

    <method name="loadLibrary">
      <body>
        <![CDATA[
          // optional connection
          var theServiceTree = document.getElementById( 'frame_servicetree' );
          if (theServiceTree) theServiceTree.launchServiceURL( "chrome://songbird/content/xul/main_pane.xul?library" );
        ]]>
      </body>
    </method>

    <method name="getCurrentPlaylist">
      <body>
        <![CDATA[
          var pl = document.__CURRENTPLAYLIST__;
          if (!pl) pl = document.__CURRENTWEBPLAYLIST__;
          if (!pl) return null;
          if ( pl.wrappedJSObject )
            pl = pl.wrappedJSObject;
          return pl;
        ]]>
      </body>
    </method>
    

   </implementation>
 
  </binding>





  <!-- ARTIST DISPLAY -->




  <binding id="artist" extends="chrome://songbird/content/bindings/remote_label.xml#remote_label">
  
  <implementation>

    <constructor>
      this.data  = "metadata.artist";
    </constructor>

   </implementation>
 
  </binding>




  <!-- TITLE DISPLAY -->




  <binding id="title" extends="chrome://songbird/content/bindings/remote_label.xml#remote_label">
  
  <implementation>

    <constructor>
      this.data  = "metadata.title";
      this.autotip = this.getAttribute("autotip");
      if (this.autotip) {
        var onremoteartistalbumchange = { 
          _that: null, 
          handleEvent: function( event ) { this._that.rebuildTip(); } 
        } onremoteartistalbumchange._that = this;
        this.remote_artist = new sbIDataRemote( "metadata.artist" );
        this.remote_artist.bindCallbackFunction(onremoteartistalbumchange, true);
        this.remote_album = new sbIDataRemote( "metadata.album" );
        this.remote_album.bindCallbackFunction(onremoteartistalbumchange, true);
        this.rebuildTip();
      }
    </constructor>

    <method name="rebuildTip">
      <body>
        <![CDATA[
          try {
            var tip = "";
            if (this.remote_artist.getValue().length > 0) {
              tip = this.remote_artist.getValue();
            }
            if (this.remote_album.getValue().length > 0) {
              if (tip.length > 0) tip += " / ";
              tip += this.remote_album.getValue();
            }
            this.label.setAttribute("tooltiptext", tip);
          } catch (e) {
            alert("player_controls.xml - rebuildTip - " + e);
          }
        ]]>
      </body>
    </method>

   </implementation>
 
  </binding>




  <!-- ALBUM DISPLAY -->




  <binding id="album" extends="chrome://songbird/content/bindings/remote_label.xml#remote_label">
  
  <implementation>

    <constructor>
      this.data  = "metadata.album";
    </constructor>

   </implementation>
 
  </binding>




  <!-- TIME ELAPSED DISPLAY -->




  <binding id="timeelapsed" extends="chrome://songbird/content/bindings/remote_label.xml#remote_label">
  
  <implementation>

    <constructor>
      this.data  = "metadata.position.str";
    </constructor>

   </implementation>
 
  </binding>




  <!-- GENRE DISPLAY -->




  <binding id="genre" extends="chrome://songbird/content/bindings/remote_label.xml#remote_label">
  
  <implementation>

    <constructor>
      this.data  = "metadata.genre";
    </constructor>

   </implementation>
 
  </binding>




  <!-- NUM PLAYLIST ITEMS DISPLAY -->




  <binding id="numplaylistitems" extends="chrome://songbird/content/bindings/remote_label.xml#remote_label">
  
  <implementation>

    <constructor>
      this.data  = "playlist.numitems";
    </constructor>

   </implementation>
 
  </binding>




  <!-- PLAYER SCANNING DISPLAY -->




  <binding id="scanning" extends="chrome://songbird/content/bindings/remote_label.xml#remote_label">
  
  <implementation>

    <constructor>
      this.data  = "backscan.status";
      this.bindvisible = SBDataBindElementAttribute( "backscan.status", this.label, "hidden", true, false, "value == ''" );
      this.setAttribute("onmousedown", "SBDataSetValue('backscan.paused', SBDataGetIntValue('backscan.paused') == 0 );");
    </constructor>

   </implementation>
 
  </binding>

</bindings>

