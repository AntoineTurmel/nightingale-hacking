<?xml version="1.0"?>
<!--
/*
//
// BEGIN SONGBIRD GPL
// 
// This file is part of the Songbird web player.
//
// Copyright© 2006 POTI, Inc.
// http://songbirdnest.com
// 
// This file may be licensed under the terms of of the
// GNU General Public License Version 2 (the “GPL”).
// 
// Software distributed under the License is distributed 
// on an “AS IS” basis, WITHOUT WARRANTY OF ANY KIND, either 
// express or implied. See the GPL for the specific language 
// governing rights and limitations.
//
// You should have received a copy of the GPL along with this 
// program. If not, go to http://www.gnu.org/licenses/gpl.html
// or write to the Free Software Foundation, Inc., 
// 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
// 
// END SONGBIRD GPL
//
 */
-->

<!DOCTYPE window SYSTEM "chrome://songbird/locale/songbird.dtd" >

<bindings xmlns="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
          xmlns:xbl="http://www.mozilla.org/xbl">


  
  
  <!-- TRACK EDITOR CONTROL -->

  
  
  
  <binding id="trackeditor" extends="chrome://songbird/content/bindings/drawer.xml#drawer">

  <implementation>

    <constructor>
      <![CDATA[
      ]]>
    </constructor>
    <destructor>
    </destructor>
    
    <field name="basedoc">null</field>

    <method name="setBaseDocument">
      <parameter name="doc"/>
      <body>
        this.basedoc = doc;
      </body>
    </method>

    <method name="setDirtyObject">
      <parameter name="obj"/>
      <body>
        this.dirtyobject = obj;
      </body>
    </method>

    <method name="setMainFocusObject">
      <parameter name="obj"/>
      <body>
        this.mainfocusobject = obj;
      </body>
    </method>

    <method name="insertDrawerContent">
     <body>
       var ret = document.createElement("iframe");
       ret.setAttribute("src", "chrome://songbird/content/xul/trackeditor_form.xul");
       ret.setAttribute("height", this.getContentSize());
       return ret;
     </body>
    </method>
    
    <method name="onContentInserted">
      <body>
        <![CDATA[
          this.setObjectsToContentDoc();
        ]]>
      </body>
    </method>
    
    <method name="setObjectsToContentDoc">
      <body>
        <![CDATA[
          var iframe = this.getContent();
          if (iframe) {
            var doc = iframe.contentDocument;
            var func = doc.__SETOBJECTS_FUNCTION__;
            if (func) {
              func(this.basedoc, this.dirtyobject, this.mainfocusobject);
            } else {
              var setobjects = { 
                _that: null, 
                handleEvent: function( event ) { this._that.setObjectsToContentDoc(); } 
              } setobjects._that = this;
              this.instanceTimer.setTimeout( setobjects, 0 );
            }
          }
        ]]>
      </body>
    </method>
    
    <method name="apply">
      <body>
        <![CDATA[
          var iframe = this.getContent();
          if (iframe) {
            var doc = iframe.contentDocument;
            var func = doc.__APPLY_FUNCTION__;
            if (func) {
              func();
            }
          }
        ]]>
      </body>
    </method>

    <method name="undo">
      <body>
        <![CDATA[
          var iframe = this.getContent();
          if (iframe) {
            var doc = iframe.contentDocument;
            var func = doc.__UNDO_FUNCTION__;
            if (func) {
              func();
            }
          }
        ]]>
      </body>
    </method>

    <method name="getContentSize">
     <body>
       return 225;
     </body>
    </method>
   
   </implementation>
 
  </binding>




  <!-- EXTENDED TRACK EDITOR CONTROL -->

  
  
  
  <binding id="exttrackeditor" extends="chrome://songbird/content/bindings/drawer.xml#drawer">

  <implementation>

    <constructor>
      <![CDATA[
        this.controls = Array();
      ]]>
    </constructor>
    <destructor>
      if (this.playlistevt) this.playlistevt.removeEventListener("playlist-selchange", this.selchangeevt, false);
    </destructor>
    
    <field name="controls">null</field>
    <field name="basedoc">null</field>
    <field name="guids">null</field>

    <method name="setBaseDocument">
      <parameter name="doc"/>
      <body>
        this.basedoc = doc;
        this.watchPlaylist();
      </body>
    </method>
    
    <property name="exclude">
      <getter>
        return this.getAttribute("exclude");
      </getter>
      <setter>
        return this.setAttribute("exclude", val);
      </setter>
    </property>

    <method name="insertDrawerContent">
     <body>
       // fixed size parent for the drawer content
       var ret = document.createElement("hbox");
       ret.setAttribute("class", "sb_faceplate");
       ret.setAttribute("height", this.getContentSize());
       
       // scrollable container for the controls
       var container = document.createElement("vbox");
       container.setAttribute("flex", "1");
       container.setAttribute("style", "overflow: auto;");
       ret.appendChild(container);
       
       // db controls
       this.appendControls(container);

       return ret;
     </body>
    </method> 

    <method name="getContentSize">
     <body>
       return 100;
     </body>
    </method>

    <method name="apply">
      <body>
        <![CDATA[
          for (var i=0;i<this.controls.length;i++)
            this.controls[i].apply();
        ]]>
      </body>
    </method>

    <method name="undo">
      <body>
        <![CDATA[
          for (var i=0;i<this.controls.length;i++)
            this.controls[i].undo();
        ]]>
      </body>
    </method>
    
    <method name="appendControls">
      <parameter name="parent"/>
      <body>
        <![CDATA[
          // Load up the string bundle
          var src = "chrome://songbird/locale/songbird.properties";
          var stringBundleService =
              Components.classes["@mozilla.org/intl/stringbundle;1"]
              .getService(Components.interfaces.nsIStringBundleService);
          var stringbundle = stringBundleService.createBundle( src );

          // enumerate the list of metadata columns and for each of them, check if it is in the exclusion list
          var ml = Components.classes["@songbirdnest.com/Songbird/MediaLibrary;1"].createInstance(Components.interfaces.sbIMediaLibrary);
          var query = Components.classes["@songbirdnest.com/Songbird/DatabaseQuery;1"].createInstance(Components.interfaces.sbIDatabaseQuery);
          query.setDatabaseGUID("songbird"); // todo: make it watch the db as well as the guid !
          ml.setQueryObject(query);
          
          ml.getColumnInfo();
          var destcols = query.getResultObject();
          for (var i=0;i<destcols.getRowCount();i++) {
            // if not, create a control for that column using its data type and readonly status
            var name = destcols.getRowCellByColumn(i, "column_name");
            if (this.isExcluded(name)) continue;
            var readablename = destcols.getRowCellByColumn(i, "readable_name");
            var type = destcols.getRowCellByColumn(i, "type");
            var ro = destcols.getRowCellByColumn(i, "readonly");
            var elem;
            if (ro != 0) elem = document.createElement("dbedit_label");
            else elem = document.createElement("dbedit_textbox");
            if (type == 'numeric') elem.setAttribute("numeric", true);
            if (ro != 0) elem.setAttribute("readonly", "true");
            elem.setAttribute("column", name);
            if (ro != 0) elem.setAttribute("class", "dialog_textbox");
            else elem.setAttribute("class", "dialog_label");
            elem.setAttribute("flex", "1");
            // create a container for the element, add a descriptive label and a spacer to it
            var hbox = document.createElement("hbox");
            hbox.setAttribute("height", "32");
            var label = document.createElement("label");
            label.setAttribute("class", "dialog_label");
            if (readablename.slice(0, 1) == "&") 
            {
              try
              {
                readablename = stringbundle.GetStringFromName( readablename.substr( 1, readablename.length ) );
              }
              catch( err )
              {
              }
            }
            label.setAttribute("value", readablename);
            label.setAttribute("width", "96");
            var spacer = document.createElement("spacer");
            spacer.setAttribute("width", "5");
            hbox.appendChild(label);
            hbox.appendChild(spacer);
            hbox.appendChild(elem);
            // add the container to the parent
            parent.appendChild(hbox);
            // register the db control
            this.controls.push(elem);
            // do not set the guid yet, the controls are not inserted in the dom at this point, so the xbl has not been instantiated, wait for onContentInserted
          }
        ]]>
      </body>
    </method>
    
    <method name="onContentInserted">
      <body>
        <![CDATA[
          // set dirty object
          for (var i=0;i<this.controls.length;i++) this.controls[i].dirtyobject = this.dirtyobject;
          // set controls guids
          this.loadSelection();
        ]]>
      </body>
    </method>
    
    <method name="onPlaylistSelectionChanged">
      <body>
        <![CDATA[
          if (this.dirtyobject && this.dirtyobject.isDirty()) return; // ignore new selection if anything has been edited
          if (this.mainfocusobject && this.mainfocusobject.isFocused()) return; // ignore new selection if the window is focused (the selection can't possibly have been made by the user!)
          this.loadSelection();
        ]]>
      </body>
    </method>
    
    <method name="isExcluded">
      <parameter name="col"/>
      <body>
        <![CDATA[
          var excludelist = this.exclude;
          var excludearray = excludelist.split(";");
          for (var i=0;i<excludearray.length;i++)
            if (excludearray[i].toUpperCase() == col.toUpperCase()) return true;
          return false;
        ]]>
      </body>
    </method>
    
    <method name="watchPlaylist">
      <body>
        <![CDATA[
          var playlist = this.basedoc.__CURRENTPLAYLIST__;
          if (playlist)
          {
            var onselchange = { 
              _that: null, 
              handleEvent: function( event ) { this._that.onPlaylistSelectionChanged(); } 
            } onselchange._that = this;
            this.selchangeevt = onselchange;
            this.playlistevt = playlist;
            playlist.addEventListener("playlist-selchange", this.selchangeevt, false);
          }
        ]]>
      </body>
    </method>

    <method name="loadSelection">
      <body>
        <![CDATA[
          var guids = Array();
          var playlist = this.basedoc.__CURRENTPLAYLIST__;
          if (playlist && playlist.tree.columns) 
          {
            var guid_column = playlist.tree.columns["uuid"];
            if (guid_column && playlist.tree.view && playlist.tree.view.selection)
            {
              var rangeCount = playlist.tree.view.selection.getRangeCount();
              if (rangeCount == 0) return; // abort !
              for (var i=0; i < rangeCount; i++) 
              {
                var start = {};
                var end = {};
                playlist.tree.view.selection.getRangeAt( i, start, end );
                for (var j=start.value;j<=end.value;j++)
                {
                  // Get the text of the hidden tree cell, this contains the uuid.
                  var guid = playlist.tree.view.getCellText( j, guid_column );
                  guids.push(guid);
                }
              }
            }
          }
          this.guids = guids;
          this.onTrackChange();
        ]]>
      </body>
    </method>

    <method name="onTrackChange">
      <body>
        <![CDATA[
          for (var i=0;i<this.controls.length;i++)
          {
            this.controls[i].guids = this.guids;
            this.controls[i].undo();
          }
        ]]>
      </body>
    </method>

    <method name="setDirtyObject">
      <parameter name="obj"/>
      <body>
        <![CDATA[
          this.dirtyobject = obj;
        ]]>
      </body>
    </method>

    <method name="setMainFocusObject">
      <parameter name="obj"/>
      <body>
        <![CDATA[
          this.mainfocusobject = obj;
        ]]>
      </body>
    </method>


  </implementation>
 
  </binding>

</bindings>

