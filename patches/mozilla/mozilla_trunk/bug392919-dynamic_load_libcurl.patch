Index: toolkit/crashreporter/client/Makefile.in
===================================================================
RCS file: /cvsroot/mozilla/toolkit/crashreporter/client/Makefile.in,v
retrieving revision 1.13
diff -u -p -r1.13 Makefile.in
--- toolkit/crashreporter/client/Makefile.in	10 Oct 2007 18:49:04 -0000	1.13
+++ toolkit/crashreporter/client/Makefile.in	26 Oct 2007 02:59:03 -0000
@@ -83,7 +83,7 @@ LIBS += \
   $(NULL)
 LOCAL_INCLUDES += -I$(srcdir)
 OS_CXXFLAGS += $(MOZ_GTK2_CFLAGS)
-OS_LIBS += $(MOZ_GTK2_LIBS) -lcurl
+OS_LIBS += $(MOZ_GTK2_LIBS)
 CPPSRCS += http_upload.cc
 FORCE_USE_PIC=1
 endif
Index: toolkit/crashreporter/google-breakpad/src/common/linux/http_upload.cc
===================================================================
RCS file: /cvsroot/mozilla/toolkit/crashreporter/google-breakpad/src/common/linux/http_upload.cc,v
retrieving revision 1.1
diff -u -p -r1.1 http_upload.cc
--- toolkit/crashreporter/google-breakpad/src/common/linux/http_upload.cc	25 Jul 2007 01:06:12 -0000	1.1
+++ toolkit/crashreporter/google-breakpad/src/common/linux/http_upload.cc	26 Oct 2007 02:59:03 -0000
@@ -28,6 +28,7 @@
 // OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 #include <cassert>
+#include <dlfcn.h>
 #include <curl/curl.h>
 #include <curl/easy.h>
 #include <curl/types.h>
@@ -65,65 +66,96 @@ bool HTTPUpload::SendRequest(const strin
   if (!CheckParameters(parameters))
     return false;
 
-  CURL *curl = curl_easy_init();
-  CURLcode err_code = CURLE_OK;
+  void *curlLib = dlopen("libcurl.so.4", RTLD_NOW);
+  if (!curlLib) {
+    curlLib = dlopen("libcurl.so.3", RTLD_NOW);
+  }
+  if (!curlLib) {
+    return false;
+  }
 
-  if (curl) {
-    curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
-    curl_easy_setopt(curl, CURLOPT_USERAGENT, kUserAgent);
-    // Set proxy information if necessary.
-    if (!proxy.empty())
-      curl_easy_setopt(curl, CURLOPT_PROXY, proxy.c_str());
-    if (!proxy_user_pwd.empty())
-      curl_easy_setopt(curl, CURLOPT_PROXYUSERPWD, proxy_user_pwd.c_str());
-
-    struct curl_httppost *formpost = NULL;
-    struct curl_httppost *lastptr = NULL;
-    // Add form data.
-    map<string, string>::const_iterator iter = parameters.begin();
-    for (; iter != parameters.end(); ++iter)
-      curl_formadd(&formpost, &lastptr,
-                   CURLFORM_COPYNAME, iter->first.c_str(),
-                   CURLFORM_COPYCONTENTS, iter->second.c_str(),
-                   CURLFORM_END);
-
-    // Add form file.
-    curl_formadd(&formpost, &lastptr,
-                 CURLFORM_COPYNAME, file_part_name.c_str(),
-                 CURLFORM_FILE, upload_file.c_str(),
-                 CURLFORM_END);
+  CURL* (*curl_easy_init)(void);
+  *(void**) (&curl_easy_init) = dlsym(curlLib, "curl_easy_init");
+  CURL *curl = (*curl_easy_init)();
 
-    curl_easy_setopt(curl, CURLOPT_HTTPPOST, formpost);
+  if (!curl) {
+    dlclose(curlLib);
+    return false;
+  }
 
-    // Disable 100-continue header.
-    struct curl_slist *headerlist = NULL;
-    char buf[] = "Expect:";
-    headerlist = curl_slist_append(headerlist, buf);
-    curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headerlist);
-
-    if (response_body != NULL) {
-      curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteCallback);
-      curl_easy_setopt(curl, CURLOPT_WRITEDATA,
-                       reinterpret_cast<void *>(response_body));
-    }
+  CURLcode err_code = CURLE_OK;
+  CURLcode (*curl_easy_setopt)(CURL *, CURLoption, ...);
+  *(void**) (&curl_easy_setopt) = dlsym(curlLib, "curl_easy_setopt");
+  (*curl_easy_setopt)(curl, CURLOPT_URL, url.c_str());
+  (*curl_easy_setopt)(curl, CURLOPT_USERAGENT, kUserAgent);
+  // Set proxy information if necessary.
+  if (!proxy.empty())
+    (*curl_easy_setopt)(curl, CURLOPT_PROXY, proxy.c_str());
+  if (!proxy_user_pwd.empty())
+    (*curl_easy_setopt)(curl, CURLOPT_PROXYUSERPWD, proxy_user_pwd.c_str());
+
+  struct curl_httppost *formpost = NULL;
+  struct curl_httppost *lastptr = NULL;
+  // Add form data.
+  CURLFORMcode (*curl_formadd)(struct curl_httppost **, struct curl_httppost **, ...);
+  *(void**) (&curl_formadd) = dlsym(curlLib, "curl_formadd");
+  dlerror();
+  map<string, string>::const_iterator iter = parameters.begin();
+  for (; iter != parameters.end(); ++iter)
+    (*curl_formadd)(&formpost, &lastptr,
+                 CURLFORM_COPYNAME, iter->first.c_str(),
+                 CURLFORM_COPYCONTENTS, iter->second.c_str(),
+                 CURLFORM_END);
 
-    err_code = curl_easy_perform(curl);
+  // Add form file.
+  (*curl_formadd)(&formpost, &lastptr,
+               CURLFORM_COPYNAME, file_part_name.c_str(),
+               CURLFORM_FILE, upload_file.c_str(),
+               CURLFORM_END);
+
+  (*curl_easy_setopt)(curl, CURLOPT_HTTPPOST, formpost);
+
+  // Disable 100-continue header.
+  struct curl_slist *headerlist = NULL;
+  char buf[] = "Expect:";
+  struct curl_slist* (*curl_slist_append)(struct curl_slist *, const char *);
+  *(void**) (&curl_slist_append) = dlsym(curlLib, "curl_slist_append");
+  headerlist = (*curl_slist_append)(headerlist, buf);
+  (*curl_easy_setopt)(curl, CURLOPT_HTTPHEADER, headerlist);
+
+  if (response_body != NULL) {
+    (*curl_easy_setopt)(curl, CURLOPT_WRITEFUNCTION, WriteCallback);
+    (*curl_easy_setopt)(curl, CURLOPT_WRITEDATA,
+                     reinterpret_cast<void *>(response_body));
+  }
+
+  CURLcode (*curl_easy_perform)(CURL *);
+  *(void**) (&curl_easy_perform) = dlsym(curlLib, "curl_easy_perform");
+  err_code = (*curl_easy_perform)(curl);
 #ifndef NDEBUG
-    if (err_code != CURLE_OK)
-      fprintf(stderr, "Failed to send http request to %s, error: %s\n",
-              url.c_str(),
-              curl_easy_strerror(err_code));
+  const char* (*curl_easy_strerror)(CURLcode);
+  *(void**) (&curl_easy_strerror) = dlsym(curlLib, "curl_easy_strerror");
+  if (err_code != CURLE_OK)
+    fprintf(stderr, "Failed to send http request to %s, error: %s\n",
+            url.c_str(),
+            (*curl_easy_strerror)(err_code));
 #endif
 
-    if (curl != NULL)
-      curl_easy_cleanup(curl);
-    if (formpost != NULL)
-      curl_formfree(formpost);
-    if (headerlist != NULL)
-      curl_slist_free_all(headerlist);
-    return err_code == CURLE_OK;
+  void (*curl_easy_cleanup)(CURL *);
+  *(void**) (&curl_easy_cleanup) = dlsym(curlLib, "curl_easy_cleanup");
+  (*curl_easy_cleanup)(curl);
+  if (formpost != NULL) {
+    void (*curl_formfree)(struct curl_httppost *);
+    *(void**) (&curl_formfree) = dlsym(curlLib, "curl_formfree");
+    (*curl_formfree)(formpost);
+  }
+  if (headerlist != NULL) {
+    void (*curl_slist_free_all)(struct curl_slist *);
+    *(void**) (&curl_slist_free_all) = dlsym(curlLib, "curl_slist_free_all");
+    (*curl_slist_free_all)(headerlist);
   }
-  return false;
+  dlclose(curlLib);
+  return err_code == CURLE_OK;
 }
 
 // static
