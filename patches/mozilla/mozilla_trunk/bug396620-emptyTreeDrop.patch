Index: layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp
===================================================================
RCS file: /cvsroot/mozilla/layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp,v
retrieving revision 1.332
diff -u -r1.332 nsTreeBodyFrame.cpp
--- layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp	11 Oct 2007 08:18:52 -0000	1.332
+++ layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp	12 Oct 2007 19:26:57 -0000
@@ -1264,6 +1264,12 @@
   return row;
 }
 
+PRBool
+nsTreeBodyFrame::IsInVisibleSpace(PRInt32 aX, PRInt32 aY)
+{
+  return (aY <= (mRowHeight * mPageLength));
+}
+
 void
 nsTreeBodyFrame::CheckTextForBidi(nsAutoString& aText)
 {
@@ -2601,7 +2607,9 @@
         mSlots->mTimer = nsnull;
       }
 
-      if (mSlots->mDropRow >= 0) {
+      if ((mSlots->mDropRow >= 0) ||
+          ((mSlots->mDropRow == -1) &&
+           (mSlots->mDropOrient == nsITreeView::DROP_AFTER))) {
         if (!mSlots->mTimer && mSlots->mDropOrient == nsITreeView::DROP_ON) {
           // Either there wasn't a timer running or it was just killed above.
           // If over a folder, start up a timer to open the folder.
@@ -4228,6 +4236,14 @@
         *aOrient = nsITreeView::DROP_AFTER;
     }
   }
+  else if (IsInVisibleSpace(xTwips, yTwips)) {
+    // Drop after last row.  Return with drop after even if there are no rows.
+    if (mRowCount > 0)
+      *aRow = mRowCount - 1;
+    else
+      *aRow = -1;
+    *aOrient = nsITreeView::DROP_AFTER;
+  }
 
   if (CanAutoScroll(*aRow)) {
     // Get the max value from the look and feel service.
Index: layout/xul/base/src/tree/src/nsTreeBodyFrame.h
===================================================================
RCS file: /cvsroot/mozilla/layout/xul/base/src/tree/src/nsTreeBodyFrame.h,v
retrieving revision 1.121
diff -u -r1.121 nsTreeBodyFrame.h
--- layout/xul/base/src/tree/src/nsTreeBodyFrame.h	23 Aug 2007 15:57:55 -0000	1.121
+++ layout/xul/base/src/tree/src/nsTreeBodyFrame.h	12 Oct 2007 19:26:57 -0000
@@ -241,6 +241,11 @@
   // coordinate system of this frame.
   PRInt32 GetRowAt(nscoord aX, nscoord aY);
 
+  // An internal visible hit test.  Returns true if coordinates are in visible
+  // space of frame, even if they're not in a tree row.  aX and aY are expected
+  // to be in app units in the coordinate system of this frame.
+  PRBool IsInVisibleSpace(nscoord aX, nscoord aY);
+
   // Check for bidi characters in the text, and if there are any, ensure
   // that the prescontext is in bidi mode.
   void CheckTextForBidi(nsAutoString& aText);
