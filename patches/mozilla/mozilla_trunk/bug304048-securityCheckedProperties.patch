Index: js/src/xpconnect/idl/nsIXPConnect.idl
===================================================================
RCS file: /cvsroot/mozilla/js/src/xpconnect/idl/nsIXPConnect.idl,v
retrieving revision 1.50
diff -u -p -r1.50 nsIXPConnect.idl
--- js/src/xpconnect/idl/nsIXPConnect.idl	2 May 2007 20:20:21 -0000	1.50
+++ js/src/xpconnect/idl/nsIXPConnect.idl	10 Jul 2007 17:35:09 -0000
@@ -675,6 +675,17 @@ interface nsIXPConnect : nsISupports
     void flagSystemFilenamePrefix(in string aFilenamePrefix);
 
     /**
+     * Get a native pointer of type aIID from aJSObject if the object
+     * is a wrapped native or a wrapped JS object, but never create a
+     * new wrapper, only use existing ones.
+     */
+    void
+    getNativeOfJSObject(in JSContextPtr aJSContext,
+                        in JSObjectPtr  aJSObj,
+                        in nsIIDRef     aIID,
+                        [iid_is(aIID),retval] out nsQIResult result);
+
+    /**
      * Restore an old prototype for wrapped natives of type
      * aClassInfo. This should be used only when restoring an old
      * scope into a state close to where it was prior to
Index: js/src/xpconnect/src/XPCDispConvert.cpp
===================================================================
RCS file: /cvsroot/mozilla/js/src/xpconnect/src/XPCDispConvert.cpp,v
retrieving revision 1.15
diff -u -p -r1.15 XPCDispConvert.cpp
--- js/src/xpconnect/src/XPCDispConvert.cpp	8 Jul 2007 07:08:29 -0000	1.15
+++ js/src/xpconnect/src/XPCDispConvert.cpp	10 Jul 2007 17:35:09 -0000
@@ -331,6 +331,7 @@ JSBool XPCDispConvert::JSToCOM(XPCCallCo
                 obj, 
                 &NSID_IDISPATCH,
                 nsnull, 
+                PR_TRUE, 
                 &err))
             {
                 // Avoid cleaning up garbage
Index: js/src/xpconnect/src/nsXPConnect.cpp
===================================================================
RCS file: /cvsroot/mozilla/js/src/xpconnect/src/nsXPConnect.cpp,v
retrieving revision 1.119
diff -u -p -r1.119 nsXPConnect.cpp
--- js/src/xpconnect/src/nsXPConnect.cpp	10 Jul 2007 04:07:45 -0000	1.119
+++ js/src/xpconnect/src/nsXPConnect.cpp	10 Jul 2007 17:35:09 -0000
@@ -1067,7 +1067,7 @@ nsXPConnect::WrapJS(JSContext * aJSConte
 
     nsresult rv;
     if(!XPCConvert::JSObject2NativeInterface(ccx, result, aJSObj,
-                                             &aIID, nsnull, &rv))
+                                             &aIID, nsnull, PR_TRUE, &rv))
         return rv;
     return NS_OK;
 }
@@ -1093,7 +1093,7 @@ nsXPConnect::WrapJSAggregatedToNative(ns
 
     nsresult rv;
     if(!XPCConvert::JSObject2NativeInterface(ccx, result, aJSObj,
-                                             &aIID, aOuter, &rv))
+                                             &aIID, aOuter, PR_TRUE, &rv))
         return rv;
     return NS_OK;
 }
@@ -2014,6 +2014,30 @@ nsXPConnect::FlagSystemFilenamePrefix(co
     return NS_OK;
 }
 
+/* void getNativeOfJSObject(in JSContextPtr aJSContext, in JSObjectPtr aJSObj, in nsIIDRef aIID, [iid_is(aIID),retval] out nsQIResult result); */
+NS_IMETHODIMP
+nsXPConnect::GetNativeOfJSObject(JSContext * aJSContext,
+                                 JSObject * aJSObj,
+                                 const nsIID & aIID,
+                                 void * *result)
+{
+    NS_ASSERTION(aJSContext, "bad param");
+    NS_ASSERTION(aJSObj, "bad param");
+    NS_ASSERTION(result, "bad param");
+
+    *result = nsnull;
+
+    XPCCallContext ccx(NATIVE_CALLER, aJSContext);
+    if(!ccx.IsValid())
+        return UnexpectedFailure(NS_ERROR_FAILURE);
+
+    nsresult rv;
+    if(!XPCConvert::JSObject2NativeInterface(ccx, result, aJSObj,
+                                             &aIID, nsnull, PR_FALSE, &rv))
+        return rv;
+    return NS_OK;
+}
+
 #ifdef DEBUG
 /* These are here to be callable from a debugger */
 JS_BEGIN_EXTERN_C
Index: js/src/xpconnect/src/xpcconvert.cpp
===================================================================
RCS file: /cvsroot/mozilla/js/src/xpconnect/src/xpcconvert.cpp,v
retrieving revision 1.112
diff -u -p -r1.112 xpcconvert.cpp
--- js/src/xpconnect/src/xpcconvert.cpp	8 Jul 2007 07:08:29 -0000	1.112
+++ js/src/xpconnect/src/xpcconvert.cpp	10 Jul 2007 17:35:09 -0000
@@ -1029,7 +1029,7 @@ XPCConvert::JSData2Native(XPCCallContext
             }
 
             return JSObject2NativeInterface(ccx, (void**)d, obj, iid,
-                                            nsnull, pErr);
+                                            nsnull, PR_TRUE, pErr);
         }
         default:
             NS_ASSERTION(0, "bad type");
@@ -1207,6 +1207,7 @@ XPCConvert::JSObject2NativeInterface(XPC
                                      void** dest, JSObject* src,
                                      const nsID* iid,
                                      nsISupports* aOuter,
+                                     PRBool createNew,
                                      nsresult* pErr)
 {
     NS_ASSERTION(dest, "bad param");
@@ -1216,7 +1217,7 @@ XPCConvert::JSObject2NativeInterface(XPC
     JSContext* cx = ccx.GetJSContext();
 
     *dest = nsnull;
-     if(pErr)
+    if(pErr)
         *pErr = NS_ERROR_XPC_BAD_CONVERT_JS;
 
     nsISupports* iface;
@@ -1265,8 +1266,15 @@ XPCConvert::JSObject2NativeInterface(XPC
 
     // else...
 
+    nsresult rv;
+
     nsXPCWrappedJS* wrapper;
-    nsresult rv = nsXPCWrappedJS::GetNewOrUsed(ccx, src, *iid, aOuter, &wrapper);
+    if (createNew) {
+        rv = nsXPCWrappedJS::GetNewOrUsed(ccx, src, *iid, aOuter, &wrapper);
+    } else {
+        rv = nsXPCWrappedJS::GetUsedOnly(ccx, src, *iid, aOuter, &wrapper);
+    }
+
     if(pErr)
         *pErr = rv;
     if(NS_SUCCEEDED(rv) && wrapper)
Index: js/src/xpconnect/src/xpcprivate.h
===================================================================
RCS file: /cvsroot/mozilla/js/src/xpconnect/src/xpcprivate.h,v
retrieving revision 1.221
diff -u -p -r1.221 xpcprivate.h
--- js/src/xpconnect/src/xpcprivate.h	10 Jul 2007 04:07:45 -0000	1.221
+++ js/src/xpconnect/src/xpcprivate.h	10 Jul 2007 17:35:10 -0000
@@ -2338,6 +2338,12 @@ public:
                  REFNSIID aIID,
                  nsISupports* aOuter,
                  nsXPCWrappedJS** wrapper);
+    static nsresult
+    GetUsedOnly(XPCCallContext& ccx,
+                JSObject* aJSObj,
+                REFNSIID aIID,
+                nsISupports* aOuter,
+                nsXPCWrappedJS** wrapperResult);
 
     nsISomeInterface* GetXPTCStub() { return mXPTCStub; }
     JSObject* GetJSObject() const {return mJSObj;}
@@ -2513,6 +2519,7 @@ public:
                                            void** dest, JSObject* src,
                                            const nsID* iid,
                                            nsISupports* aOuter,
+                                           PRBool createNew,
                                            nsresult* pErr);
 
     /**
Index: js/src/xpconnect/src/xpcwrappedjs.cpp
===================================================================
RCS file: /cvsroot/mozilla/js/src/xpconnect/src/xpcwrappedjs.cpp,v
retrieving revision 1.57
diff -u -p -r1.57 xpcwrappedjs.cpp
--- js/src/xpconnect/src/xpcwrappedjs.cpp	8 Jul 2007 07:08:29 -0000	1.57
+++ js/src/xpconnect/src/xpcwrappedjs.cpp	10 Jul 2007 17:35:10 -0000
@@ -417,6 +417,68 @@ return_wrapper:
     return NS_OK;
 }
 
+// static
+nsresult
+nsXPCWrappedJS::GetUsedOnly(XPCCallContext& ccx,
+                            JSObject* aJSObj,
+                            REFNSIID aIID,
+                            nsISupports* aOuter,
+                            nsXPCWrappedJS** wrapperResult)
+{
+    JSObject2WrappedJSMap* map;
+    JSBool hasProp;
+    JSObject* rootJSObj;
+    nsXPCWrappedJS* root;
+    nsXPCWrappedJS* wrapper = nsnull;
+    nsXPCWrappedJSClass *clazz = nsnull;
+    XPCJSRuntime* rt = ccx.GetRuntime();
+
+    map = rt->GetWrappedJSMap();
+    if(!map)
+    {
+        NS_ASSERTION(map,"bad map");
+        return NS_ERROR_FAILURE;
+    }
+
+    nsXPCWrappedJSClass::GetNewOrUsed(ccx, aIID, &clazz);
+    if(!clazz)
+        return NS_ERROR_FAILURE;
+
+    // GetRootJSObject will attempt to call a QueryInterface function on
+    // aJSObj. If QueryInterface doesn't exist on the object then a strict
+    // warning will be emitted, so check to make sure that the QueryInterface
+    // function exists before proceeding.
+    if(JS_HasProperty(ccx.GetJSContext(), aJSObj,
+                      rt->GetStringName(XPCJSRuntime::IDX_QUERY_INTERFACE),
+                      &hasProp) && hasProp)
+        rootJSObj = clazz->GetRootJSObject(ccx, aJSObj);
+    else
+        rootJSObj = aJSObj;
+
+    NS_RELEASE(clazz);
+
+    if(!rootJSObj)
+        return NS_ERROR_FAILURE;
+
+    // look for the root wrapper
+    {   // scoped lock
+        XPCAutoLock lock(rt->GetMapLock());
+        root = map->Find(rootJSObj);
+    }
+
+    if(root)
+    {
+        if((nsnull != (wrapper = root->Find(aIID))) ||
+           (nsnull != (wrapper = root->FindInherited(aIID))))
+        {
+            NS_ADDREF(wrapper);
+        }
+    }
+
+    *wrapperResult = wrapper;
+    return NS_OK;
+}
+
 nsXPCWrappedJS::nsXPCWrappedJS(XPCCallContext& ccx,
                                JSObject* aJSObj,
                                nsXPCWrappedJSClass* aClass,
Index: caps/src/nsScriptSecurityManager.cpp
===================================================================
RCS file: /cvsroot/mozilla/caps/src/nsScriptSecurityManager.cpp,v
retrieving revision 1.319
diff -u -p -r1.319 nsScriptSecurityManager.cpp
--- caps/src/nsScriptSecurityManager.cpp	8 Jul 2007 07:08:06 -0000	1.319
+++ caps/src/nsScriptSecurityManager.cpp	10 Jul 2007 17:35:10 -0000
@@ -493,6 +493,12 @@ nsScriptSecurityManager::CheckObjectAcce
     if (!ssm)
         return JS_FALSE;
 
+    nsCOMPtr<nsISupports> native;
+    nsresult rv =
+        sXPConnect->GetNativeOfJSObject(cx, obj,
+                                        NS_GET_IID(nsISupports),
+                                        getter_AddRefs(native));
+
     // Get the object being accessed.  We protect these cases:
     // 1. The Function.prototype.caller property's value, which might lead
     //    an attacker up a call-stack to a function or another object from
@@ -505,11 +511,13 @@ nsScriptSecurityManager::CheckObjectAcce
 
     // Do the same-origin check -- this sets a JS exception if the check fails.
     // Pass the parent object's class name, as we have no class-info for it.
-    nsresult rv =
-        ssm->CheckPropertyAccess(cx, target, JS_GetClass(cx, obj)->name, id,
-                                 (mode & JSACC_WRITE) ?
-                                 nsIXPCSecurityManager::ACCESS_SET_PROPERTY :
-                                 nsIXPCSecurityManager::ACCESS_GET_PROPERTY);
+    rv = ssm->CheckPropertyAccessImpl(( (mode & JSACC_WRITE) ?
+                                        nsIXPCSecurityManager::ACCESS_SET_PROPERTY :
+                                        nsIXPCSecurityManager::ACCESS_GET_PROPERTY ),
+                                      nsnull, cx, target, native, nsnull,
+                                      nsnull, JS_GET_CLASS(cx, obj)->name, id,
+                                      nsnull);
+
 
     if (NS_FAILED(rv))
         return JS_FALSE; // Security check failed (XXX was an error reported?)
@@ -771,14 +779,24 @@ nsScriptSecurityManager::CheckPropertyAc
     nsXPIDLCString objectSecurityLevel;
     if (checkedComponent)
     {
-        nsCOMPtr<nsIXPConnectWrappedNative> wrapper;
-        nsCOMPtr<nsIInterfaceInfo> interfaceInfo;
-        const nsIID* objIID;
-        rv = aCallContext->GetCalleeWrapper(getter_AddRefs(wrapper));
-        if (NS_SUCCEEDED(rv))
-            rv = wrapper->FindInterfaceWithMember(aProperty, getter_AddRefs(interfaceInfo));
-        if (NS_SUCCEEDED(rv))
-            rv = interfaceInfo->GetIIDShared(&objIID);
+        const nsIID* objIID = nsnull;
+        if (aCallContext) {
+            // If we have a call context, find the wrapper and the IID
+            // with the member in question to pass to
+            // nsISecurityCheckedComponent, if not, pass a null IID
+            // and it's up to the implementation to decide if it wants
+            // to permit access or not.
+            nsCOMPtr<nsIXPConnectWrappedNative> wrapper;
+            nsCOMPtr<nsIInterfaceInfo> interfaceInfo;
+            rv = aCallContext->GetCalleeWrapper(getter_AddRefs(wrapper));
+            if (NS_SUCCEEDED(rv))
+                rv = wrapper->FindInterfaceWithMember(aProperty, getter_AddRefs(interfaceInfo));
+            if (NS_SUCCEEDED(rv))
+                rv = interfaceInfo->GetIIDShared(&objIID);
+        } else {
+            rv = NS_OK;
+        }
+
         if (NS_SUCCEEDED(rv))
         {
             switch (aAction)
